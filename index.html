<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çœ‹çš„åˆ°ã€è½èªªçš„ è¡Œç¨‹é€£çµæŸ¥è©¢</title>
    <!-- è¼‰å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¨­å®š Tailwind CSS é…ç½®ï¼Œä½¿ç”¨ Inter å­—é«” -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#FADD42',       // Main Color (Yellow/Gold)
                        'primary-dark': '#E5C83C',  // Darker shade for hover
                        'accent': '#0097B2',        // Accent/Secondary Color (Teal/Cyan)
                        'background': '#f9fafb',
                    }
                }
            }
        }
    </script>
    <style>
        /* è‡ªå®šç¾©æ»¾å‹•æ¢æ¨£å¼ï¼Œè®“çµæœåˆ—è¡¨æ›´ç¾è§€ */
        #results-list::-webkit-scrollbar, #admin-data-textarea::-webkit-scrollbar, #admin-list-container::-webkit-scrollbar {
            width: 8px;
        }
        #results-list::-webkit-scrollbar-thumb, #admin-data-textarea::-webkit-scrollbar-thumb, #admin-list-container::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 4px;
        }
        #results-list::-webkit-scrollbar-track, #admin-data-textarea::-webkit-scrollbar-track, #admin-list-container::-webkit-scrollbar-track {
            background-color: #f3f4f6;
        }
        .link-text {
            word-break: break-all;
        }
        /* Admin Row æ¢å¾©ç‚º 4 å€‹æ¬„ä½ + æ“ä½œ */
        .admin-row {
            grid-template-columns: 1fr 1fr 1.5fr 3fr auto; /* åœ‹å®¶, é¡å‹, åç¨±, é€£çµ, æ“ä½œ */
            gap: 0.5rem;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid #f3f4f6;
            display: grid;
        }
        /* è‡ªå®šç¾©ç¢ºèªå½ˆçª—çš„åŸºæœ¬æ¨£å¼ */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body class="bg-gray-50 font-sans p-4 md:p-8 min-h-screen">
    <div class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 md:p-10 border border-gray-100">

        <!-- Header and Mode Toggle -->
        <div class="flex justify-between items-center mb-6 border-b pb-4">
            <h1 class="text-3xl font-extrabold text-gray-800">çœ‹çš„åˆ°ã€è½èªªçš„ è¡Œç¨‹é€£çµæŸ¥è©¢</h1>
            <div class="flex items-center space-x-4">
                <button id="mode-toggle-btn" class="px-4 py-2 text-sm font-semibold rounded-lg transition duration-150 ease-in-out shadow-md bg-primary text-gray-900 hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2">
                    åˆ‡æ›è‡³å¾Œå°
                </button>
            </div>
        </div>
        
        <!-- Notification/Message Box -->
        <div id="message-box" class="hidden p-4 rounded-lg text-sm mb-4" role="alert"></div>

        <!-- Password Prompt Container -->
        <div id="password-prompt" class="p-4 bg-red-50 border border-red-200 rounded-lg mb-4 hidden">
            <label for="admin-password" class="block text-sm font-medium text-red-700 mb-2">è«‹è¼¸å…¥å¾Œå°å¯†ç¢¼:</label>
            <div class="flex space-x-2">
                <input type="password" id="admin-password" placeholder="å¯†ç¢¼" class="p-2 border border-red-300 rounded-lg focus:ring-red-500 focus:border-red-500 w-full shadow-sm">
                <button id="password-submit-btn" class="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 transition duration-150 shadow-md">ç¢ºèª</button>
            </div>
        </div>
        
        <!-- Loading Spinner -->
        <div id="loading-spinner" class="text-center p-8 text-gray-500 hidden">
             <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-accent mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-2 text-sm">æ­£åœ¨å¾é›²ç«¯è¼‰å…¥è³‡æ–™...</p>
        </div>

        <!-- Search View (Default) -->
        <div id="search-view" class="space-y-6 hidden">
            <h2 class="text-2xl font-bold text-gray-700">æŸ¥è©¢è³¼è²·é€£çµ</h2>
            
            <!-- Global Coupon Display -->
            <div id="global-coupon-display" class="p-4 rounded-lg text-sm mb-4 bg-accent/10 border-l-4 border-accent hidden">
                <h3 class="font-bold text-accent mb-1 flex items-center">
                    <!-- Icon: Tag -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
                    æœ€æ–°å„ªæƒ è³‡è¨Š (é»æ“Šè¤‡è£½)
                </h3>
                <p id="global-coupon-text-content" class="text-gray-700 font-medium whitespace-pre-wrap cursor-pointer" title="é»æ“Šè¤‡è£½å„ªæƒ ç¢¼"></p>
                <p class="text-xs text-blue-500 mt-2 font-semibold">æ­¤è³‡è¨Šä¾†è‡ªé›²ç«¯è³‡æ–™åº«ï¼Œå°‡æœƒå³æ™‚åŒæ­¥ã€‚</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- åœ‹å®¶/åœ°å€ ç¯©é¸å™¨ -->
                <select id="country-filter" class="p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150 shadow-sm col-span-1 bg-white">
                    <!-- é¸é …å°‡ç”± JS å¡«å…… -->
                </select>
                <!-- ç¥¨åˆ¸é¡å‹ ç¯©é¸å™¨ -->
                <select id="type-filter" class="p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150 shadow-sm col-span-1 bg-white">
                    <!-- é¸é …å°‡ç”± JS å¡«å…… -->
                </select>
                <!-- é—œéµå­—ç¯©é¸å™¨ -->
                <input type="text" id="keyword-filter" placeholder="åŸå¸‚ã€ç¥¨åˆ¸åç¨±æˆ–é¡å‹é—œéµå­—" class="p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150 shadow-sm col-span-1">
            </div>

            <div class="text-lg font-semibold text-gray-600 pt-4">æŸ¥è©¢çµæœ (<span id="result-count">0</span> ç­†)</div>
            <div id="results-list" class="max-h-[60vh] overflow-y-auto border border-gray-200 rounded-lg shadow-inner bg-gray-50">
                <div class="p-4 text-center text-gray-500">è«‹è¼¸å…¥é—œéµå­—é€²è¡ŒæŸ¥è©¢æˆ–ç­‰å¾…é›²ç«¯è³‡æ–™è¼‰å…¥...</div>
            </div>
        </div>

        <!-- Admin View (Hidden by Default) -->
        <div id="admin-view" class="space-y-6 hidden">
            <h2 class="text-2xl font-bold text-red-600">è¡Œç¨‹è³‡æ–™é›²ç«¯å¾Œå°</h2>
            <div class="bg-blue-100 border-l-4 border-blue-500 p-4 rounded-lg">
                <p class="text-sm text-blue-800 font-bold">ğŸ’¡ æç¤ºï¼šæ­¤ç‰ˆæœ¬å°‡æ‰€æœ‰è®Šæ›´å³æ™‚å„²å­˜åˆ°é›²ç«¯å…¬é–‹è³‡æ–™åº«ã€‚</p>
                <p class="text-xs text-blue-700 mt-1">æ‚¨åœ¨å¾Œå°å°è¡Œç¨‹è³‡æ–™çš„æ“ä½œï¼ŒæœƒåŒæ­¥å„²å­˜åˆ°**å…¬é–‹è³‡æ–™é›†**ï¼Œæ‰€æœ‰ä½¿ç”¨è€…éƒ½å¯ä»¥æŸ¥è©¢åˆ°ã€‚</p>
                <p class="text-xs text-blue-700 mt-1">ç•¶å‰ä½¿ç”¨è€… ID: <code id="user-id-display" class="font-mono text-gray-900 bg-white p-0.5 rounded text-[10px] break-all">...</code></p>
            </div>

            <!-- Global Coupon Edit Section -->
            <div id="global-coupon-edit-section" class="border p-4 rounded-xl bg-white shadow-lg space-y-4">
                <h3 class="text-xl font-bold text-accent border-b pb-2">ä¸€ã€å…¨åŸŸå„ªæƒ ç¢¼æ–‡å­—ç·¨è¼¯ (å…¬é–‹è³‡æ–™)</h3>
                <p class="text-sm text-gray-600">æ­¤æ–‡å­—æœƒé¡¯ç¤ºåœ¨æ‰€æœ‰ä½¿ç”¨è€…çš„æŸ¥è©¢é é¢é ‚ç«¯ã€‚è®Šæ›´æœƒå„²å­˜åˆ°é›²ç«¯ä¸¦**ç«‹å³ç”Ÿæ•ˆ**ã€‚</p>
                <textarea id="global-coupon-textarea" rows="4" placeholder="è¼¸å…¥è¦é¡¯ç¤ºçš„å„ªæƒ ç¢¼è³‡è¨Šï¼Œä¾‹å¦‚ï¼šè¼¸å…¥ æŠ˜æ‰£ç¢¼ï¼šTAIWAN20 äº« 8æŠ˜å„ªæƒ ..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent transition duration-150 shadow-sm text-sm"></textarea>
                <div class="flex justify-end">
                    <button id="save-global-coupon-btn" class="px-6 py-3 text-sm font-bold rounded-lg transition duration-150 ease-in-out shadow-md bg-accent text-white hover:bg-accent/90 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 disabled:bg-accent/50">
                        å„²å­˜åˆ°é›²ç«¯
                    </button>
                </div>
            </div>

            <!-- Mass Import Section -->
            <div id="import-section" class="border p-4 rounded-xl bg-white shadow-lg space-y-4">
                <h3 class="text-xl font-bold text-red-600/80 border-b pb-2">äºŒã€å¤§æ‰¹åŒ¯å…¥ (å…¬é–‹è³‡æ–™)</h3>
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-lg">
                    <p class="text-sm text-yellow-800 font-medium">ğŸ’¡ æç¤ºï¼šæ‚¨åŒ¯å…¥çš„è³‡æ–™æœƒæˆç‚ºå…¬é–‹è³‡æ–™ï¼Œæ‰€æœ‰çŸ¥é“ç¨‹å¼çš„äººéƒ½å¯ä»¥æŸ¥è©¢åˆ°ã€‚</p>
                    <p class="text-sm text-yellow-800 mt-1">æ¬„ä½é †åºï¼š**åœ‹å®¶åœ°å€** &nbsp; **ç¥¨åˆ¸é¡å‹** &nbsp; **ç¥¨åˆ¸åç¨±** &nbsp; **é€£çµ**</p>
                    <p class="text-xs text-yellow-600 mt-2">ä¾‹å¦‚ï¼šå°ç£ é«˜éµ é«˜éµå–®ç¨‹ç¥¨ https://link.to/thsr</p>
                </div>
                <textarea id="admin-data-textarea" rows="10" placeholder="è²¼ä¸Šæ‚¨çš„è³‡æ–™..." class="w-full p-4 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 transition duration-150 shadow-sm text-sm"></textarea>
                <div class="flex justify-end">
                    <button id="import-data-btn" class="px-6 py-3 text-sm font-bold rounded-lg transition duration-150 ease-in-out shadow-md bg-red-600 text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 disabled:bg-red-300">
                        åŒ¯å…¥ä¸¦å„²å­˜åˆ°é›²ç«¯
                    </button>
                </div>
            </div>

            <!-- Edit/Delete Section -->
            <div id="edit-delete-section" class="border p-4 rounded-xl bg-white shadow-lg space-y-4">
                <h3 class="text-xl font-bold text-red-600/80 flex justify-between items-center border-b pb-2">
                    <span>ä¸‰ã€ç·¨è¼¯èˆ‡åˆªé™¤**å…¬é–‹**è³‡æ–™ (å…± <span id="admin-item-count">0</span> ç­†)</span>
                    <button id="clear-all-btn" class="px-3 py-1 text-xs font-semibold rounded-lg text-red-700 bg-red-100 hover:bg-red-200 transition duration-150">
                        æ¸…ç©ºæ‰€æœ‰å…¬é–‹è³‡æ–™
                    </button>
                </h3>
                
                <!-- Header Row for Admin List -->
                <div class="admin-row text-xs font-bold text-gray-600 bg-gray-100/50 rounded-lg shadow-sm">
                    <div class="hidden md:block">åœ‹å®¶/åœ°å€</div>
                    <div class="hidden md:block">ç¥¨åˆ¸é¡å‹</div>
                    <div class="hidden md:block">ç¥¨åˆ¸åç¨±</div>
                    <div class="hidden md:block">é€£çµ</div>
                    <div>æ“ä½œ</div>
                </div>

                <div id="admin-list-container" class="max-h-[60vh] overflow-y-auto border border-gray-200 rounded-lg shadow-inner">
                    <div class="text-center text-gray-500 p-4">è³‡æ–™è¼‰å…¥ä¸­...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Custom Confirmation Modal -->
    <div id="custom-confirm-modal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center p-4 hidden transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 space-y-4 transform transition-transform duration-300">
            <div class="flex items-center space-x-3 text-red-600">
                <!-- Warning Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                <h3 id="confirm-title" class="text-xl font-bold">ç¢ºèªæ“ä½œ</h3>
            </div>
            <p id="confirm-message" class="text-gray-600 text-sm">æ­¤æ“ä½œå°‡ç›´æ¥ä¿®æ”¹é›²ç«¯è³‡æ–™åº«ä¸­çš„è³‡æ–™ã€‚</p>
            <div class="flex justify-end space-x-3">
                <button id="cancel-action-btn" class="px-4 py-2 bg-gray-200 text-gray-700 text-sm font-semibold rounded-lg hover:bg-gray-300 transition duration-150">å–æ¶ˆ</button>
                <button id="confirm-action-btn" class="px-4 py-2 bg-red-600 text-white text-sm font-semibold rounded-lg hover:bg-red-700 transition duration-150 shadow-md">ç¢ºèªåŸ·è¡Œ</button>
            </div>
        </div>
    </div>

    <!-- é›²ç«¯è³‡æ–™åº« (Firestore) èˆ‡ç¨‹å¼é‚è¼¯ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; // æš«æ™‚è¨»è§£ï¼Œé¿å…éå¤š log

        // ----------------------------------------------------
        // æ ¸å¿ƒè®Šæ•¸èˆ‡åˆå§‹åŒ–
        // ----------------------------------------------------

        // å¿…é ˆä½¿ç”¨çš„ç’°å¢ƒè®Šæ•¸
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const ADMIN_PASSWORD = '2266'; // å¾Œå°å¯†ç¢¼
        let isEditingId = null; // ç•¶å‰æ­£åœ¨ç·¨è¼¯çš„ document ID
        let pendingAction = null; // å„²å­˜ç¢ºèªå¾Œè¦åŸ·è¡Œçš„å‡½å¼
        let db, auth;
        let userId = null;
        let items = []; // è¡Œç¨‹è³‡æ–™é™£åˆ—ï¼Œç”± onSnapshot å³æ™‚æ›´æ–°
        let globalCouponText = ''; // å…¨åŸŸå„ªæƒ ç¢¼æ–‡å­—ï¼Œç”± onSnapshot å³æ™‚æ›´æ–°
        let initialAuthCheckDone = false; // ç¢ºä¿èªè­‰å¾Œçš„é‚è¼¯åªåŸ·è¡Œä¸€æ¬¡

        // DOM å…ƒç´  (éƒ¨åˆ†çœç•¥ï¼Œä¿æŒèˆ‡ HTML çµæ§‹ä¸€è‡´)
        const modeToggleBtn = document.getElementById('mode-toggle-btn');
        const searchView = document.getElementById('search-view');
        const adminView = document.getElementById('admin-view');
        const countryFilter = document.getElementById('country-filter'); 
        const typeFilter = document.getElementById('type-filter'); 
        const keywordFilter = document.getElementById('keyword-filter');
        const resultsList = document.getElementById('results-list');
        const resultCount = document.getElementById('result-count');
        const adminDataTextarea = document.getElementById('admin-data-textarea');
        const importDataBtn = document.getElementById('import-data-btn');
        const messageBox = document.getElementById('message-box');
        const passwordPrompt = document.getElementById('password-prompt');
        const adminPasswordInput = document.getElementById('admin-password');
        const passwordSubmitBtn = document.getElementById('password-submit-btn');
        const loadingSpinner = document.getElementById('loading-spinner');

        // ADMIN DOM ELEMENTS
        const adminListContainer = document.getElementById('admin-list-container');
        const adminItemCount = document.getElementById('admin-item-count');
        const clearAllBtn = document.getElementById('clear-all-btn');
        const userIdDisplay = document.getElementById('user-id-display');
        
        // GLOBAL COUPON ELEMENTS
        const globalCouponDisplay = document.getElementById('global-coupon-display');
        const globalCouponTextContent = document.getElementById('global-coupon-text-content');
        const globalCouponTextarea = document.getElementById('global-coupon-textarea');
        const saveGlobalCouponBtn = document.getElementById('save-global-coupon-btn');
        
        // CUSTOM CONFIRM MODAL ELEMENTS
        const customConfirmModal = document.getElementById('custom-confirm-modal');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmActionBtn = document.getElementById('confirm-action-btn');
        const cancelActionBtn = document.getElementById('cancel-action-btn');

        // ----------------------------------------------------
        // Firebase & èªè­‰è¨­å®š
        // ----------------------------------------------------

        function setupFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                // setLogLevel('Debug'); // uncomment for deep debugging
                auth = getAuth(app);
                
                // è™•ç†èªè­‰ç‹€æ…‹
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        console.log("Authenticated with UID:", userId);
                    } else {
                        // èªè­‰å¤±æ•—æˆ–ç™»å‡º
                        userId = null;
                        userIdDisplay.textContent = 'åŒ¿åæ¨¡å¼ (ç„¡å€‹äººæ“ä½œæ¬Šé™)';
                        console.warn("Authentication failed, operating in anonymous mode.");
                    }

                    if (!initialAuthCheckDone) {
                        initialAuthCheckDone = true;
                        // èªè­‰å®Œæˆå¾Œï¼Œå•Ÿå‹•è³‡æ–™ç›£è½å™¨ï¼ˆç„¡è«–æ˜¯å¦æœ‰ userIdï¼Œå…¬é–‹è³‡æ–™éƒ½èƒ½è®€å–ï¼‰
                        setupFirestoreListeners();
                        loadingSpinner.classList.add('hidden');
                        searchView.classList.remove('hidden');
                    }
                });
                
                authenticate();
            } catch (error) {
                console.error("Firebase Initialization Failed:", error);
                loadingSpinner.innerHTML = '<p class="text-red-600">Firebase åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥é…ç½®ã€‚</p>';
                showMessage('æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•å¤±æ•—ï¼Œç„¡æ³•é€£ç·šåˆ°è³‡æ–™åº«ã€‚', 'error');
            }
        }

        async function authenticate() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // ä½¿ç”¨åŒ¿åç™»å…¥ç¢ºä¿è‡³å°‘æœ‰ base æ¬Šé™
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase authentication failed:", error);
                showMessage('èªè­‰å¤±æ•—ï¼Œç„¡æ³•æ“ä½œè³‡æ–™åº«ã€‚', 'error');
            }
        }
        
        // ----------------------------------------------------
        // Firestore å³æ™‚ç›£è½å™¨ (ä¿è­‰è·¨ç€è¦½å™¨è³‡æ–™åŒæ­¥çš„æ ¸å¿ƒ)
        // ----------------------------------------------------

        function setupFirestoreListeners() {
            if (!db) return; // DB å¿…é ˆå·²åˆå§‹åŒ–

            // 1. ç›£è½è¡Œç¨‹é …ç›® (å…¬é–‹è³‡æ–™: æ‰€æœ‰ç”¨æˆ¶çš†å¯è®€)
            // *** è·¯å¾‘è¨­å®šç‚º PUBLIC é›†åˆ ***
            const itemsRef = collection(db, `artifacts/${appId}/public/data/itinerary_items`);
            onSnapshot(itemsRef, (snapshot) => {
                // æ ¸å¿ƒï¼šæ¯æ¬¡è³‡æ–™åº«è®Šæ›´éƒ½æœƒè§¸ç™¼æ­¤å‡½å¼ï¼Œç¢ºä¿æ‰€æœ‰ç€è¦½å™¨è³‡æ–™ä¸€è‡´
                items = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                })).sort((a, b) => (a.country + a.name).localeCompare(b.country + b.name)); // æœ¬åœ°æ’åº
                
                console.log("Itinerary Items (Public) updated:", items.length);
                // é‡æ–°å¡«å……ç¯©é¸å™¨ä¸¦é‡æ–°æ¸²æŸ“åˆ—è¡¨
                populateCountryFilter(items);
                populateTypeFilter(items);
                filterAndRenderList(); 
                renderAdminList(items); 
            }, (error) => {
                console.error("Error listening to public itinerary items:", error);
                // å³ä½¿å…¬é–‹è³‡æ–™è®€å–å¤±æ•—ï¼Œä¹Ÿæ¸…ç©ºæœ¬åœ°è³‡æ–™ä¸¦é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                items = [];
                filterAndRenderList(); 
                renderAdminList(items); 
                showMessage('å…¬é–‹è¡Œç¨‹è³‡æ–™è®€å–å¤±æ•—ï¼šé€£ç·šæœ‰å•é¡Œã€‚', 'error');
            });


            // 2. ç›£è½å…¨åŸŸå„ªæƒ ç¢¼ (å…¬é–‹è³‡æ–™: æ‰€æœ‰ç”¨æˆ¶å…±ç”¨)
            const couponDocRef = doc(db, `artifacts/${appId}/public/data/global_config`, 'coupon_text');
            onSnapshot(couponDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    globalCouponText = docSnap.data().text || '';
                } else {
                    globalCouponText = '';
                }
                console.log("Global Coupon updated:", globalCouponText.length > 0 ? 'Yes' : 'No');
                // æ›´æ–° UI
                updateAdminCouponTextUI();
                filterAndRenderList(); // é€™æœƒè§¸ç™¼æŸ¥è©¢é é¢çš„å„ªæƒ ç¢¼é¡¯ç¤ºæ›´æ–°
            }, (error) => {
                console.warn("Error listening to coupon data:", error);
                // å³ä½¿å…¬é–‹è³‡æ–™è®€å–å¤±æ•—ï¼Œä¹Ÿæ¸…ç©ºæœ¬åœ°æ•¸æ“šé¿å…é¡¯ç¤ºéŒ¯èª¤è³‡è¨Š
                globalCouponText = '';
                updateAdminCouponTextUI();
                filterAndRenderList(); 
            });
        }


        // ----------------------------------------------------
        // æ ¸å¿ƒå·¥å…·å‡½å¼
        // ----------------------------------------------------

        /** é¡¯ç¤ºé€šçŸ¥è¨Šæ¯ */
        function showMessage(message, type = 'success') {
            messageBox.textContent = message;
            messageBox.className = 'p-4 rounded-lg text-sm mb-4';
            messageBox.classList.remove('hidden');

            if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                messageBox.classList.add('bg-accent/10', 'text-accent');
            } else if (type === 'info') {
                messageBox.classList.add('bg-blue-100', 'text-blue-700');
            }
            // è¨Šæ¯é¡¯ç¤º 5 ç§’å¾Œæ¶ˆå¤±
            setTimeout(() => messageBox.classList.add('hidden'), 5000);
        }

        /** é¡¯ç¤ºè‡ªå®šç¾©ç¢ºèªå½ˆçª— */
        function showCustomConfirm(title, message, onConfirm) {
            confirmTitle.textContent = title;
            confirmMessage.innerHTML = message;
            pendingAction = onConfirm;
            customConfirmModal.classList.remove('hidden');
        }

        /** éš±è—è‡ªå®šç¾©ç¢ºèªå½ˆçª— */
        function hideCustomConfirm() {
            customConfirmModal.classList.add('hidden');
            pendingAction = null;
        }

        // ----------------------------------------------------
        // é›²ç«¯è³‡æ–™åº«æ“ä½œï¼šæ–°å¢/ç·¨è¼¯/åˆªé™¤ (Firestore)
        // ----------------------------------------------------

        /** å„²å­˜å…¨åŸŸå„ªæƒ ç¢¼æ–‡å­— (å…¬é–‹è³‡æ–™) */
        async function saveGlobalCouponText() {
            if (!db) { showMessage('è³‡æ–™åº«å°šæœªé€£ç·šã€‚', 'error'); return; }
            const text = globalCouponTextarea.value.trim();
            // å…¬é–‹è³‡æ–™è·¯å¾‘
            const couponDocRef = doc(db, `artifacts/${appId}/public/data/global_config`, 'coupon_text');
            saveGlobalCouponBtn.disabled = true;
            try {
                await setDoc(couponDocRef, { text: text });
                showMessage('å…¨åŸŸå„ªæƒ ç¢¼æ–‡å­—å·²æ›´æ–°ä¸¦å„²å­˜åˆ°é›²ç«¯ã€‚', 'success');
            } catch (error) {
                console.error("Error setting coupon text:", error);
                showMessage('å„²å­˜å„ªæƒ ç¢¼å¤±æ•—ï¼š' + error.message, 'error');
            } finally {
                saveGlobalCouponBtn.disabled = false;
            }
        }

        /** åŒ¯å…¥è³‡æ–™ (å…¬é–‹è³‡æ–™ï¼Œä½¿ç”¨ Batch Write) */
        async function importData() {
            if (!db) { showMessage('è³‡æ–™åº«å°šæœªé€£ç·šã€‚', 'error'); return; }
            const rawData = adminDataTextarea.value.trim();
            if (!rawData) { showMessage('è«‹è²¼ä¸Šè¦åŒ¯å…¥çš„è³‡æ–™ã€‚', 'info'); return; }

            const lines = rawData.split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) { showMessage('è³‡æ–™å…§å®¹ç‚ºç©ºã€‚', 'info'); return; }

            importDataBtn.disabled = true;
            const batch = writeBatch(db);
            // *** è·¯å¾‘è¨­å®šç‚º PUBLIC é›†åˆ ***
            const itemsRef = collection(db, `artifacts/${appId}/public/data/itinerary_items`);

            let importedCount = 0;
            const invalidLines = []; 

            lines.forEach((line) => {
                // ä½¿ç”¨å¤šå€‹ç©ºæ ¼ä½œç‚ºåˆ†éš”ç¬¦
                const rawParts = line.trim().split(/\s+/).filter(p => p.length > 0); 
                
                if (rawParts.length < 4) {
                    invalidLines.push(line);
                    return;
                }
                
                const country = rawParts[0];
                const type = rawParts[1];
                const link = rawParts[rawParts.length - 1]; 
                const name = rawParts.slice(2, rawParts.length - 1).join(' '); 

                // æª¢æŸ¥é€£çµæ ¼å¼
                if (!link.startsWith('http')) {
                    invalidLines.push(line);
                    return;
                }

                const data = {
                    country: country,
                    type: type,
                    name: name,
                    link: link,
                };
                
                const newDocRef = doc(itemsRef);
                batch.set(newDocRef, data);
                importedCount++;
            });

            try {
                await batch.commit();
                
                if (invalidLines.length > 0) {
                    adminDataTextarea.value = invalidLines.join('\n');
                    showMessage(`æˆåŠŸåŒ¯å…¥ ${importedCount} ç­†è³‡æ–™åˆ°é›²ç«¯å…¬é–‹åˆ—è¡¨ã€‚æœ‰ ${invalidLines.length} ç­†è³‡æ–™å› æ ¼å¼éŒ¯èª¤è¢«å¿½ç•¥ï¼Œå·²é‡æ–°è¼‰å…¥è¼¸å…¥æ¡†ã€‚`, 'info');
                } else if (importedCount > 0) {
                    showMessage(`æˆåŠŸåŒ¯å…¥ ${importedCount} ç­†è³‡æ–™åˆ°é›²ç«¯å…¬é–‹åˆ—è¡¨ã€‚`, 'success');
                    adminDataTextarea.value = ''; 
                } else {
                    showMessage(`æ²’æœ‰è³‡æ–™è¢«åŒ¯å…¥ã€‚è«‹æª¢æŸ¥æ‚¨çš„è¼¸å…¥æ ¼å¼ã€‚`, 'error');
                    adminDataTextarea.value = ''; 
                }
            } catch (error) {
                console.error("Error batch importing data:", error);
                showMessage('å¤§æ‰¹åŒ¯å…¥å…¬é–‹è³‡æ–™å¤±æ•—ï¼š' + error.message, 'error');
            } finally {
                importDataBtn.disabled = false;
            }
        }
        
        /** è™•ç†å–®ç­†è³‡æ–™åˆªé™¤ (å…¬é–‹è³‡æ–™) */
        function handleDelete(itemId) {
            showCustomConfirm(
                'ç¢ºèªåˆªé™¤å–®ç­†å…¬é–‹è³‡æ–™',
                `æ‚¨ç¢ºå®šè¦å¾é›²ç«¯å…¬é–‹è³‡æ–™åº«ä¸­åˆªé™¤é€™ç­†è¡Œç¨‹è³‡æ–™å—ï¼Ÿé€™æœƒå½±éŸ¿åˆ°æ‰€æœ‰æŸ¥è©¢çš„ä½¿ç”¨è€…ã€‚`,
                async () => {
                    hideCustomConfirm();
                    if (!db) { showMessage('è³‡æ–™åº«å°šæœªé€£ç·šã€‚', 'error'); return; }
                    
                    // *** è·¯å¾‘è¨­å®šç‚º PUBLIC é›†åˆ ***
                    const itemDocRef = doc(db, `artifacts/${appId}/public/data/itinerary_items`, itemId);
                    try {
                        await deleteDoc(itemDocRef);
                        showMessage('å…¬é–‹è³‡æ–™å·²å¾é›²ç«¯åˆªé™¤ã€‚', 'success');
                    } catch (error) {
                        console.error("Error deleting document:", error);
                        showMessage('åˆªé™¤å¤±æ•—ï¼š' + error.message, 'error');
                    }
                }
            );
        }
        
        /** è™•ç†å–®ç­†è³‡æ–™æ›´æ–° (å…¬é–‹è³‡æ–™) */
        async function handleUpdate(itemId, country, type, name, link) {
            if (!db) { showMessage('è³‡æ–™åº«å°šæœªé€£ç·šã€‚', 'error'); return; }
            if (!country || !type || !name || !link) {
                showMessage('åœ‹å®¶ã€é¡å‹ã€åç¨±ã€é€£çµéƒ½ä¸èƒ½ç‚ºç©ºã€‚', 'error');
                return;
            }
            
            // *** è·¯å¾‘è¨­å®šç‚º PUBLIC é›†åˆ ***
            const itemDocRef = doc(db, `artifacts/${appId}/public/data/itinerary_items`, itemId);

            try {
                await updateDoc(itemDocRef, {
                    country: country.trim(),
                    type: type.trim(),
                    name: name.trim(),
                    link: link.trim(),
                });
                showMessage('å…¬é–‹è³‡æ–™å·²æ›´æ–°ä¸¦å„²å­˜åˆ°é›²ç«¯ã€‚', 'success');
                isEditingId = null; // é€€å‡ºç·¨è¼¯æ¨¡å¼ (onSnapshot æœƒè‡ªå‹•é‡æ–°æ¸²æŸ“)
            } catch (error) {
                console.error("Error updating document:", error);
                showMessage('æ›´æ–°å…¬é–‹è³‡æ–™å¤±æ•—ï¼š' + error.message, 'error');
            }
        }

        /** æ¸…ç©ºæ‰€æœ‰è³‡æ–™ (å…¬é–‹è³‡æ–™ï¼Œä½¿ç”¨ Batch Delete) */
        function clearAllData() {
            showCustomConfirm(
                'ç¢ºèªæ¸…ç©ºæ‰€æœ‰å…¬é–‹è¡Œç¨‹è³‡æ–™',
                'è­¦å‘Šï¼šç¢ºå®šè¦åˆªé™¤é›²ç«¯è³‡æ–™åº«ä¸­æ‰€æœ‰**å…¬é–‹**è¡Œç¨‹è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œæœƒå½±éŸ¿åˆ°æ‰€æœ‰æŸ¥è©¢çš„ä½¿ç”¨è€…ä¸”ç„¡æ³•å¾©åŸã€‚',
                async () => {
                    hideCustomConfirm();
                    if (!db) { showMessage('è³‡æ–™åº«å°šæœªé€£ç·šã€‚', 'error'); return; }
                    
                    // *** è·¯å¾‘è¨­å®šç‚º PUBLIC é›†åˆ ***
                    const itemsRef = collection(db, `artifacts/${appId}/public/data/itinerary_items`);
                    // ç²å–æ‰€æœ‰æ–‡ä»¶å¼•ç”¨
                    const snapshot = await getDocs(itemsRef);
                    
                    if (snapshot.empty) {
                        showMessage('ç›®å‰é›²ç«¯è³‡æ–™åº«ä¸­æ²’æœ‰è³‡æ–™å¯ä¾›æ¸…ç©ºã€‚', 'info');
                        return;
                    }

                    const batch = writeBatch(db);
                    snapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });

                    try {
                        await batch.commit();
                        showMessage(`æˆåŠŸæ¸…ç©º ${snapshot.size} ç­†é›²ç«¯å…¬é–‹è³‡æ–™ã€‚`, 'success');
                    } catch (error) {
                        console.error("Error batch deleting data:", error);
                        showMessage('æ¸…ç©ºè³‡æ–™å¤±æ•—ï¼š' + error.message, 'error');
                    }
                }
            );
        }
        
        /** æ›´æ–°ç®¡ç†å¾Œå°çš„å…¨åŸŸå„ªæƒ ç¢¼ UI */
        function updateAdminCouponTextUI() {
            if (globalCouponTextarea) {
                globalCouponTextarea.value = globalCouponText;
            }
        }

        // ----------------------------------------------------
        // ä»‹é¢é‚è¼¯ï¼šç¯©é¸èˆ‡æ¸²æŸ“ (ä¸è®Š)
        // ----------------------------------------------------

        /** å¡«å……åœ‹å®¶/åœ°å€é¸å–® */
        function populateCountryFilter(data) {
            const countries = new Set();
            data.forEach(item => {
                if (item.country && item.country.trim()) {
                    countries.add(item.country.trim());
                }
            });

            countryFilter.innerHTML = ''; 

            const defaultOption = document.createElement('option');
            defaultOption.value = ''; 
            defaultOption.textContent = 'åœ‹å®¶/åœ°å€ (å…¨éƒ¨)';
            countryFilter.appendChild(defaultOption);

            Array.from(countries).sort().forEach(country => {
                const option = document.createElement('option');
                option.value = country.toLowerCase(); 
                option.textContent = country;
                countryFilter.appendChild(option);
            });
        }
        
        /** å¡«å……ç¥¨åˆ¸é¡å‹é¸å–® */
        function populateTypeFilter(data) {
            const types = new Set();
            data.forEach(item => {
                if (item.type && item.type.trim()) {
                    types.add(item.type.trim());
                }
            });

            typeFilter.innerHTML = ''; 

            const defaultOption = document.createElement('option');
            defaultOption.value = ''; 
            defaultOption.textContent = 'ç¥¨åˆ¸é¡å‹ (å…¨éƒ¨)';
            typeFilter.appendChild(defaultOption);

            Array.from(types).sort().forEach(type => {
                const option = document.createElement('option');
                option.value = type.toLowerCase(); 
                option.textContent = type;
                typeFilter.appendChild(option);
            });
        }
        
        /** ç¯©é¸è³‡æ–™ä¸¦æ¸²æŸ“åˆ—è¡¨ (æŸ¥è©¢è¦–åœ–) */
        function filterAndRenderList() {
            const countryQuery = countryFilter.value.trim().toLowerCase(); 
            const typeQuery = typeFilter.value.trim().toLowerCase(); 
            const keywordQuery = keywordFilter.value.trim().toLowerCase();

            const filteredItems = items.filter(item => {
                const countryMatch = !countryQuery || (item.country && item.country.toLowerCase() === countryQuery);
                const typeMatch = !typeQuery || (item.type && item.type.toLowerCase() === typeQuery); 
                
                const keywordMatch = !keywordQuery || 
                    (item.name && item.name.toLowerCase().includes(keywordQuery)) || 
                    (item.type && item.type.toLowerCase().includes(keywordQuery)) ||
                    (item.country && item.country.toLowerCase().includes(keywordQuery));

                return countryMatch && typeMatch && keywordMatch; 
            });

            renderList(filteredItems);
        }

        /** æ¸²æŸ“çµæœåˆ—è¡¨ (æŸ¥è©¢è¦–åœ–) */
        function renderList(filteredItems) {
            resultsList.innerHTML = ''; 
            resultCount.textContent = filteredItems.length;

            // --- æ¸²æŸ“å…¨åŸŸå„ªæƒ ç¢¼æ–‡å­— ---
            if (globalCouponText) {
                globalCouponDisplay.classList.remove('hidden');
                globalCouponTextContent.textContent = globalCouponText;
            } else {
                globalCouponDisplay.classList.add('hidden');
            }
            
            if (filteredItems.length === 0) {
                resultsList.innerHTML = `<div class="p-6 text-center text-gray-500 bg-gray-50">æŸ¥ç„¡ç¬¦åˆæ¢ä»¶çš„ç¥¨åˆ¸è³‡æ–™ã€‚</div>`;
                return;
            }

            const listHtml = filteredItems.map((item) => {
                return `
                    <div class="p-4 border-b border-gray-100 last:border-b-0 transition duration-100 hover:bg-gray-100/50">
                        <div class="flex items-start justify-between">
                            <div class="space-y-1 w-full">
                                <div class="flex flex-wrap items-center space-x-2">
                                    <span class="bg-primary text-gray-900 text-xs font-semibold px-2.5 py-0.5 rounded-full">${item.country}</span>
                                    <span class="text-xs font-medium text-gray-500 bg-gray-200 px-2.5 py-0.5 rounded-full">${item.type}</span>
                                </div>
                                <h3 class="text-lg font-bold text-gray-800 pt-1">${item.name}</h3>
                                <p class="text-sm text-gray-500 link-text">
                                    é€£çµ: <a href="${item.link}" target="_blank" rel="noopener noreferrer" class="text-accent hover:underline">${item.link}</a>
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            resultsList.innerHTML = listHtml;
        }

        /** æ¸²æŸ“ç®¡ç†åˆ—è¡¨ (å¾Œå°è¦–åœ–) */
        function renderAdminList(allData) {
            adminListContainer.innerHTML = '';
            adminItemCount.textContent = allData.length;

            if (allData.length === 0) {
                adminListContainer.innerHTML = `<div class="text-center text-gray-500 p-4">ç›®å‰æ²’æœ‰è³‡æ–™ã€‚è«‹å…ˆåŒ¯å…¥è³‡æ–™ã€‚</div>`;
                return;
            }

            allData.forEach(item => {
                const isEditing = item.id === isEditingId;
                const row = document.createElement('div');
                row.className = `admin-row text-xs md:text-sm ${isEditing ? 'bg-red-50 ring-2 ring-red-300 rounded-lg shadow-inner' : 'hover:bg-gray-50'}`;
                row.dataset.id = item.id;

                if (isEditing) {
                    // ç·¨è¼¯æ¨¡å¼
                    row.innerHTML = `
                        <input type="text" id="edit-country-${item.id}" value="${item.country}" placeholder="åœ‹å®¶" class="p-1 border rounded-md focus:ring-red-500 focus:border-red-500 text-xs">
                        <input type="text" id="edit-type-${item.id}" value="${item.type}" placeholder="é¡å‹" class="p-1 border rounded-md focus:ring-red-500 focus:border-red-500 text-xs">
                        <input type="text" id="edit-name-${item.id}" value="${item.name}" placeholder="åç¨±" class="p-1 border rounded-md focus:ring-red-500 focus:border-red-500 text-xs col-span-1">
                        <input type="url" id="edit-link-${item.id}" value="${item.link}" placeholder="é€£çµ" class="p-1 border rounded-md focus:ring-red-500 focus:border-red-500 text-xs">
                        <div class="flex flex-col space-y-1">
                            <button data-action="save" data-id="${item.id}" class="bg-accent text-white px-2 py-1 rounded-md hover:bg-accent/80 text-xs font-medium transition duration-150">å„²å­˜</button>
                            <button data-action="cancel" data-id="${item.id}" class="bg-gray-400 text-white px-2 py-1 rounded-md hover:bg-gray-500 text-xs font-medium transition duration-150">å–æ¶ˆ</button>
                        </div>
                    `;
                    // ç¶å®šå„²å­˜äº‹ä»¶
                    row.querySelector(`button[data-action="save"]`).addEventListener('click', () => {
                        const country = document.getElementById(`edit-country-${item.id}`).value;
                        const type = document.getElementById(`edit-type-${item.id}`).value;
                        const name = document.getElementById(`edit-name-${item.id}`).value;
                        const link = document.getElementById(`edit-link-${item.id}`).value;
                        handleUpdate(item.id, country, type, name, link);
                    });
                    // ç¶å®šå–æ¶ˆäº‹ä»¶
                    row.querySelector(`button[data-action="cancel"]`).addEventListener('click', () => {
                        isEditingId = null;
                        renderAdminList(items); // onSnapshot listener will handle the re-render after actual update
                    });

                } else {
                    // é¡¯ç¤ºæ¨¡å¼
                    row.innerHTML = `
                        <div class="text-gray-700">${item.country}</div>
                        <div class="text-gray-700">${item.type}</div>
                        <div class="text-gray-700 truncate">${item.name}</div>
                        <div class="text-blue-500 link-text truncate">${item.link}</div>
                        <div class="flex flex-col space-y-1">
                            <button data-action="edit" data-id="${item.id}" class="bg-yellow-500 text-white px-2 py-1 rounded-md hover:bg-yellow-600 text-xs font-medium transition duration-150">ç·¨è¼¯</button>
                            <button data-action="delete" data-id="${item.id}" class="bg-red-500 text-white px-2 py-1 rounded-md hover:bg-red-600 text-xs font-medium transition duration-150">åˆªé™¤</button>
                        </div>
                    `;
                    // ç¶å®šç·¨è¼¯å’Œåˆªé™¤äº‹ä»¶
                    row.querySelector(`button[data-action="edit"]`).addEventListener('click', () => {
                        isEditingId = item.id;
                        renderAdminList(items); 
                    });
                    row.querySelector(`button[data-action="delete"]`).addEventListener('click', () => handleDelete(item.id));
                }

                adminListContainer.appendChild(row);
            });
        }
        
        /** æ›´æ–°ç®¡ç†å¾Œå°çš„å…¨åŸŸå„ªæƒ ç¢¼ UI */
        function updateAdminCouponTextUI() {
            if (globalCouponTextarea) {
                globalCouponTextarea.value = globalCouponText;
            }
        }

        // ----------------------------------------------------
        // æ¨¡å¼åˆ‡æ›èˆ‡äº‹ä»¶ç›£è½å™¨ (ä¸è®Š)
        // ----------------------------------------------------

        /** æª¢æŸ¥å¯†ç¢¼ä¸¦åˆ‡æ›åˆ°ç®¡ç†å“¡è¦–åœ– */
        function checkPasswordAndSwitch() {
            const enteredPassword = adminPasswordInput.value.trim();

            if (enteredPassword === ADMIN_PASSWORD) {
                // åˆ‡æ›æ¨¡å¼ï¼š'admin'
                searchView.classList.add('hidden');
                adminView.classList.remove('hidden');
                passwordPrompt.classList.add('hidden'); 
                
                // è®Šæ›´ç‚ºä¸­æ€§è‰²
                modeToggleBtn.textContent = 'åˆ‡æ›è‡³æŸ¥è©¢';
                modeToggleBtn.classList.remove('bg-primary', 'hover:bg-primary-dark', 'focus:ring-primary', 'bg-yellow-600', 'hover:bg-yellow-700', 'focus:ring-yellow-600');
                modeToggleBtn.classList.add('bg-gray-500', 'text-white', 'hover:bg-gray-600', 'focus:ring-gray-500');
                
                showMessage('å¯†ç¢¼æ­£ç¢ºï¼Œå·²åˆ‡æ›è‡³å¾Œå°ã€‚', 'success');
                adminPasswordInput.value = ''; 
                
                updateAdminCouponTextUI(); // ç¢ºä¿å¾Œå°çš„å„ªæƒ ç¢¼æ–‡æœ¬æ¡†æ˜¯æœ€æ–°çš„

            } else {
                showMessage('å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚', 'error');
                adminPasswordInput.value = ''; 
                adminPasswordInput.focus();
            }
        }

        /** æ¨¡å¼åˆ‡æ›é‚è¼¯ */
        function toggleMode() {
            const isCurrentlyAdmin = !adminView.classList.contains('hidden');

            if (!isCurrentlyAdmin) {
                // å¾æŸ¥è©¢åˆ‡æ›åˆ°å¾Œå° (éœ€è¦å¯†ç¢¼)
                passwordPrompt.classList.remove('hidden'); 
                // ä¿æŒ search view å¯è¦‹ç›´åˆ°å¯†ç¢¼é©—è­‰
                adminView.classList.add('hidden'); 
                
                adminPasswordInput.value = ''; 
                adminPasswordInput.focus();
                
                showMessage('è«‹è¼¸å…¥å¯†ç¢¼ä»¥åˆ‡æ›è‡³å¾Œå°ã€‚', 'info'); 
                
                // è®Šæ›´ç‚ºè­¦å‘Šè‰²
                modeToggleBtn.textContent = 'åˆ‡æ›è‡³å¾Œå° (å¾…ç¢ºèª)';
                modeToggleBtn.classList.remove('bg-primary', 'hover:bg-primary-dark', 'focus:ring-primary', 'bg-gray-500', 'text-white', 'hover:bg-gray-600', 'focus:ring-gray-500');
                modeToggleBtn.classList.add('bg-yellow-600', 'text-white', 'hover:bg-yellow-700', 'focus:ring-yellow-600');

            } else {
                // å¾å¾Œå°åˆ‡æ›åˆ°æŸ¥è©¢
                adminView.classList.add('hidden');
                searchView.classList.remove('hidden');
                passwordPrompt.classList.add('hidden'); 
                
                isEditingId = null; // é€€å‡ºç·¨è¼¯æ¨¡å¼
                
                // è®Šå› primary color (é»ƒè‰²)
                modeToggleBtn.textContent = 'åˆ‡æ›è‡³å¾Œå°';
                modeToggleBtn.classList.remove('bg-gray-500', 'text-white', 'hover:bg-gray-600', 'focus:ring-gray-500', 'bg-yellow-600', 'hover:bg-yellow-700', 'focus:ring-yellow-600');
                modeToggleBtn.classList.add('bg-primary', 'text-gray-900', 'hover:bg-primary-dark', 'focus:ring-primary');
            }
        }

        // --- ç¶å®šäº‹ä»¶ ---
        
        modeToggleBtn.addEventListener('click', toggleMode);
        importDataBtn.addEventListener('click', importData);
        clearAllBtn.addEventListener('click', clearAllData); 
        saveGlobalCouponBtn.addEventListener('click', saveGlobalCouponText); 
        
        // è¤‡è£½å„ªæƒ ç¢¼é‚è¼¯
        globalCouponDisplay.addEventListener('click', () => {
            if (globalCouponText) {
                const fullText = globalCouponTextContent.textContent.trim();
                let textToCopy = fullText; 
                
                const regex = /æŠ˜æ‰£ç¢¼ï¼š([^\n\s]+)/; // åŒ¹é…ã€ŒæŠ˜æ‰£ç¢¼ï¼šã€å¾Œçš„ç¬¬ä¸€å€‹éç©ºç™½å­—ä¸²
                const match = fullText.match(regex);
                
                if (match && match[1]) {
                    textToCopy = match[1].trim();
                } else {
                    textToCopy = fullText;
                    if (!textToCopy) return; 
                }
                
                try {
                    // ä½¿ç”¨ document.execCommand('copy') é€²è¡Œè¤‡è£½
                    const textarea = document.createElement('textarea');
                    textarea.value = textToCopy;
                    textarea.style.position = 'fixed'; 
                    textarea.style.left = '-9999px';
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);

                    if (match && match[1]) {
                        showMessage(`æŠ˜æ‰£ç¢¼ã€Œ${textToCopy}ã€å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼`, 'success'); 
                    } else {
                        showMessage('å„ªæƒ è³‡è¨Šå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼', 'success'); 
                    }
                } catch (err) {
                    showMessage('è¤‡è£½åˆ°å‰ªè²¼ç°¿å¤±æ•—ã€‚è«‹æ‰‹å‹•è¤‡è£½æ–‡æœ¬ã€‚', 'error');
                }
            }
        });
        
        passwordSubmitBtn.addEventListener('click', checkPasswordAndSwitch);
        
        adminPasswordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                checkPasswordAndSwitch();
            }
        });
        
        countryFilter.addEventListener('change', filterAndRenderList); 
        typeFilter.addEventListener('change', filterAndRenderList); 
        keywordFilter.addEventListener('input', filterAndRenderList);
        
        // ç¶å®šè‡ªå®šç¾©å½ˆçª—çš„æŒ‰éˆ•äº‹ä»¶
        confirmActionBtn.addEventListener('click', () => {
            if (pendingAction) {
                pendingAction();
            }
        });

        cancelActionBtn.addEventListener('click', hideCustomConfirm);

        // æ‡‰ç”¨ç¨‹å¼å•Ÿå‹• (åˆå§‹åŒ–)
        window.onload = function() {
            loadingSpinner.classList.remove('hidden');
            searchView.classList.add('hidden');
            setupFirebase();
        }

    </script>
</body>
</html>